<link rel="import" href="../polymer/polymer.html"> 
<link rel="import" href="../core-selector/core-selector.html"> 
<link rel="import" href="../th-data-utility/th-data-utility.html"> 

<!--
A Thelma component providing solution to no problem in particular.

##### Example

    <th-u-data-selector></th-u-data-selector>

@element th-u-data-selector
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://thelmanews.github.io/th-u-data-selector
-->

<polymer-element name="th-u-data-selector" attributes="input selectionSetting selections ">
  <template>
    <style>
        core-selector {
          min-height: 10px;
          display: inline-block;
          max-height: 123px;
          overflow-y: scroll; 
        }

        core-selector .col {
          display: inline-block;
          margin: 0 3px;
          padding: 1px;
          border: 1px solid #EEE;
        }
        core-selector .core-selected {
          background-color: #ccc;

        }
        label {
          vertical-align: top;
        }
    </style>
    <th-data-utility id="data_utility"></th-data-utility>

    <template if="{{_dataAttributes}}">
      <div class="columnNames">
        <template repeat="{{sel, index in selectionSettings}}">
          <div>
            <label>
             {{sel.name}}: 
            </label>
              
            <core-selector id="value_selector" selected="{{selections[index]}}" valueattr="label" multi="{{sel.multi}}">
                <template repeat="{{attr in _dataAttributes}}">
                  <template if="{{attr | isEligible(index)}}">
                    <div class="col" label="{{attr}}">{{attr}}</div>
                  </template>
                </template>
            </core-selector>
          
          </div>
        </template>
      </div>
    </template>
  </template>
  <script>
    Polymer({
     
      selections: ['',''],
      selectionSettings: [
        {name: 'label', type: 'any', multi: false},
        {name: 'value', type: 'numerical', multi: true}
      ],
      observe: {
        input: "_extractAttributes",
        numOfSelections: "_extractAttributes"        
      },
      ready: function() {

      this.selections = ['',''];
      this.selectionSettings = [
        {name: 'label', type: 'any', multi: false},
        {name: 'value', type: 'numerical', multi: true}
      ];

        this._extractAttributes();

        this.addEventListener('core-select', function() {
          this.fire('th-data-selection-changed');
        }.bind(this));
      },
      _extractAttributes: function() {

        var self = this;
        if(self.input && self.input[0]) {
          self._dataAttributes = Object.keys(self.input[0]);
          self.getDefaultSelections();

        }


      },

      getDefaultSelections: function(){
        
        var self = this;
        self.selectionSettings.forEach(function(dp, i) {
          if(dp.multi===false) {
            self.selections[i] = Object.keys(self.input[0])[i];
          }
          else {
            self.selections[i] =   Object.keys(self.input[0]).filter(function(key, index) {
              return self.isEligible (key,1);
            });
          }
        });
        
        //self.selections = [self.selectedLabel, self.selectedValues];
        this.fire('th-data-selection-changed');
      },

      isEligible: function(attr,index) {
        var self = this;
        if(self.selectionSettings[index] && self.selectionSettings[index].type==='numerical') {
          var num =  self.$.data_utility.isColumnNumeric(self.input, attr );
          return num;
        }
        
        return true;
      }

    });
  </script>
</polymer-element>